<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Camera1架构和ASD流程源码分析 | liiiyx's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Camera1架构和ASD流程源码分析</h1><a id="logo" href="/.">liiiyx's Blog</a><p class="description">一如既往, 万事胜意 / 1024199338@qq.com</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Camera1架构和ASD流程源码分析</h1><div class="post-meta">Jan 12, 2018<span> | </span><span class="category"><a href="/categories/Android/">Android</a></span></div><div class="post-content"><h2 id="相关文件路径"><a href="#相关文件路径" class="headerlink" title="相关文件路径"></a>相关文件路径</h2><blockquote>
<p><strong>Java层:</strong><br>/vendor/mediatek/proprietary/packages/apps/Camera/src/</p>
<ul>
<li>/com/mediatek/camera/AdditionManager.java</li>
<li>/com/mediatek/camera/addition/Asd.java</li>
<li>/com/android/camera/CameraManager.java</li>
<li>/com/android/camera/AndroidCamera.java</li>
</ul>
<p><strong>framework层：</strong><br>/frameworks/av/camera/Camera.cpp<br>/frameworks/av/camera/CameraBase.cpp<br>/frameworks/av/services/camera/libcameraservice/api1/CameraClient.cpp<br>/frameworks/av/services/camera/libcameraservice/mediatek/api1/CameraClient.cpp<br>/frameworks/base/core/java/android/hardware/Camera.java</p>
<p><strong>jni层：</strong><br> /frameworks/base/core/jni/android_hardware_Camera.cpp</p>
<p><strong>Hardware层：</strong><br>vendor/mediatek/proprietary/hardware/mtkcam/</p>
<ul>
<li>legacy/platform/mt6735/core/featureio/pipe/aaa/Hal3AAdapter1.cpp</li>
<li>legacy/platform/mt6735/core/featureio/pipe/asd/asd_hal_base.cpp</li>
<li>legacy/platform/mt6735/core/featureio/pipe/asd/asd/asd_hal.cpp</li>
<li>legacy/platform/mt6735/v1/client/CamClient/FD/Asd/AsdClient.cpp</li>
<li>legacy/platform/mt6735/v1/client/CamClient/FD/FDClient.Thread.cpp</li>
<li>main/hal/device1/common/Cam1DeviceBase.cpp</li>
<li>legacy/v1/client/CamClient/CamClient.cpp</li>
</ul>
</blockquote>
<h2 id="1-引言"><a href="#1-引言" class="headerlink" title="1. 引言"></a>1. 引言</h2><p>最近遇到了ASD(自动场景检测)在室内光线较好的情况下，会选择到夜间模式，需要调整其阈值。于是分析了MTK平台对于Camera1架构的源码实现流程，梳理了ASD的工作流程(App-&gt;framework-&gt;jni-&gt;HAL)，但也仅是对源码流程的一个贯穿，没有对具体实现深入分析。以后若有时间进一步学习，再做补充。</p>
<p>分析思路：</p>
<ol>
<li>先以设置里打开ASD开关为触发点，预览界面/场景检测结果更新为截止点，抓取camera的mtklog；</li>
<li>检索log的关键信息，找到App层的入口，分析在上层及framework层所做的操作；</li>
<li>检索log的关键信息，找到HAL层的入口，分析在HAL层的事件处理以及消息传递；</li>
<li>结合2和3的分析结果，分析framework层与HAL层的jni通信；</li>
</ol>
<h2 id="2-架构"><a href="#2-架构" class="headerlink" title="2. 架构"></a>2. 架构</h2><p>camera架构图如下：</p>
<p><img src="https://source.android.com/devices/camera/images/ape_fwk_camera.png" alt="Android 相机架构"></p>
<blockquote>
<p><strong>应用框架</strong><br>应用代码位于应用框架级别，它利用 <a href="http://developer.android.com/reference/android/hardware/Camera.html" target="_blank" rel="noopener">android.hardware.Camera</a> API 来与相机硬件互动。在内部，此代码会调用相应的 JNI 粘合类，以访问与该相机互动的原生代码。</p>
<p><strong>JNI</strong><br>与 <a href="http://developer.android.com/reference/android/hardware/Camera.html" target="_blank" rel="noopener">android.hardware.Camera</a> 关联的 JNI 代码位于 <code>frameworks/base/core/jni/android_hardware_Camera.cpp</code>。此代码会调用较低级别的原生代码以获取对物理相机的访问权限，并返回用于在框架级别创建 <a href="http://developer.android.com/reference/android/hardware/Camera.html" target="_blank" rel="noopener">android.hardware.Camera</a> 对象的数据。</p>
<p><strong>原生框架</strong><br>在 <code>frameworks/av/camera/Camera.cpp</code> 中定义的原生框架可提供相当于 <a href="http://developer.android.com/reference/android/hardware/Camera.html" target="_blank" rel="noopener">android.hardware.Camera</a> 类的原生类。此类会调用 IPC binder 代理，以获取对相机服务的访问权限。</p>
<p><strong>Binder IPC 代理</strong><br>IPC binder 代理有助于越过进程边界实现通信。调用相机服务的 <code>frameworks/av/camera</code> 目录中有 3 个相机 binder 类。ICameraService 是相机服务的接口，ICamera 是已打开的特定相机设备的接口，ICameraClient 是返回应用框架的设备接口。</p>
<p><strong>相机服务</strong><br>位于 <code>frameworks/av/services/camera/libcameraservice/CameraService.cpp</code> 下的相机服务是与 HAL 进行互动的实际代码。</p>
<p><strong>HAL</strong><br>硬件抽象层定义了由相机服务调用且您必须实现以确保相机硬件正常运行的标准接口。</p>
<p><strong>内核驱动程序</strong><br>相机的驱动程序可与实际相机硬件和您的 HAL 实现进行互动。相机和驱动程序必须支持 YV12 和 NV21 图片格式，以便在显示和视频录制时支持预览相机图片。</p>
</blockquote>
<p>以上信息引用自：<a href="https://source.android.com/devices/camera/" target="_blank" rel="noopener">https://source.android.com/devices/camera/</a> 。接下来顺着Camera1的纵线流程来分析MTK平台上ASD是如何工作的。</p>
<h2 id="3-启动流程-App、Framework层"><a href="#3-启动流程-App、Framework层" class="headerlink" title="3. 启动流程(App、Framework层)"></a>3. 启动流程(App、Framework层)</h2><h3 id="3-1-启动流程图"><a href="#3-1-启动流程图" class="headerlink" title="3.1 启动流程图"></a>3.1 启动流程图</h3><p><img src="/2018/01/12/Camera1架构和ASD流程源码分析/framework层流程图.png" alt="framework层流程图"></p>
<p>接下来，从源码来说说这个流程图。</p>
<h3 id="3-2-AdditionManager-java"><a href="#3-2-AdditionManager-java" class="headerlink" title="3.2 AdditionManager.java"></a>3.2 AdditionManager.java</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public void onCameraParameterReady(boolean isMode) &#123;</span><br><span class="line">    // 参数变化时会调用到这里</span><br><span class="line">    Log.i(TAG, &quot;[onCameraParameterReady]isMode = &quot; + isMode);</span><br><span class="line">    Vector&lt;ICameraAddition&gt; curAddition = mModeAddition;</span><br><span class="line">    if (!isMode) &#123;</span><br><span class="line">        curAddition = mNormalAddition;</span><br><span class="line">    &#125;</span><br><span class="line">    for (ICameraAddition addition : curAddition) &#123;</span><br><span class="line">        // Asd继承自CameraAddition</span><br><span class="line">        // 在这里判断Asd开关是否支持&amp;打开</span><br><span class="line">        boolean isSupport = addition.isSupport();</span><br><span class="line">        boolean isOpen = addition.isOpen();</span><br><span class="line">        if (isSupport &amp;&amp; !isOpen) &#123;</span><br><span class="line">        	// 如果支持且开关已打开，则调用Asd的open方法打开Asd模式</span><br><span class="line">            addition.open();</span><br><span class="line">        &#125; else if (!isSupport &amp;&amp; isOpen) &#123;</span><br><span class="line">            addition.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-3-Asd-java"><a href="#3-3-Asd-java" class="headerlink" title="3.3 Asd.java"></a>3.3 Asd.java</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void open() &#123;</span><br><span class="line">    Log.d(TAG, &quot;[open]...&quot;);</span><br><span class="line">    startAsd();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public void startAsd() &#123;</span><br><span class="line">    Log.i(TAG, &quot;[startAsd]...&quot;);</span><br><span class="line">    // 更新当前camera设备实例</span><br><span class="line">    updateCameraDevice();</span><br><span class="line">    if (mICameraDevice == null) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    // 这里通知framework层做Asd Callback的初始化和设置</span><br><span class="line">    // 用来接收来自HAL层的消息</span><br><span class="line">    mICameraDevice.setAsdCallback(mASDCaptureCallback);</span><br><span class="line">    // 更新ASD状态</span><br><span class="line">    mCurrentState = AsdState.STATE_OPENED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-4-CameraManager-java"><a href="#3-4-CameraManager-java" class="headerlink" title="3.4 CameraManager.java"></a>3.4 CameraManager.java</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void setAsdCallback(AsdListener asdListener) &#123;</span><br><span class="line">	// 创建AsdListener实例</span><br><span class="line">    mCameraDevice.setAsdCallback(asdListener == null ? null : new AsdListenerImpl(asdListener));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public void setAsdCallback(AsdCallback asdCallback) &#123;</span><br><span class="line">	// 通知内部类CameraHandler，设置AsdCallback</span><br><span class="line">    mCameraHandler.obtainMessage(SET_ASD_CALLBACK, asdCallback).sendToTarget();</span><br><span class="line">    waitDone();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private class CameraHandler extends Handler &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void handleMessage(final Message msg) &#123;</span><br><span class="line">        ...</span><br><span class="line">        case SET_ASD_CALLBACK:</span><br><span class="line">        // 这里mCamera是ICamera实例，接口在AndroidCamera中实现</span><br><span class="line">        mCamera.setAsdCallback((AsdCallback) msg.obj);</span><br><span class="line">        return;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-5-AndroidCamera-java"><a href="#3-5-AndroidCamera-java" class="headerlink" title="3.5 AndroidCamera.java"></a>3.5 AndroidCamera.java</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public void setAsdCallback(AsdCallback cb) &#123;</span><br><span class="line">	// 调用Camera1接口设置Asd的回调</span><br><span class="line">    mCamera.setAsdCallback(cb);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-6-android-hardware-Camera-java"><a href="#3-6-android-hardware-Camera-java" class="headerlink" title="3.6 android.hardware.Camera.java"></a>3.6 android.hardware.Camera.java</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * @hide</span><br><span class="line"> * @internal</span><br><span class="line"> *</span><br><span class="line"> * Registers a callback to be invoked when auto scene is detected</span><br><span class="line"> * @param cb the callback to run</span><br><span class="line"> */</span><br><span class="line">public final void setAsdCallback(AsdCallback cb) &#123;</span><br><span class="line">	// 设置framework层的AsdCallback回调实例</span><br><span class="line">    mAsdCallback = cb;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-7-AsdCallback的创建"><a href="#3-7-AsdCallback的创建" class="headerlink" title="3.7 AsdCallback的创建"></a>3.7 AsdCallback的创建</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// Asd.java的内部类，实现了AsdListener接口</span><br><span class="line">// 用于接收来自HAL层的消息，然后通知camera ui做出相应处理</span><br><span class="line">private final AsdListener mASDCaptureCallback = new AsdListener() &#123;</span><br><span class="line">    public void onDeviceCallback(int scene) &#123;</span><br><span class="line">        Log.i(TAG, &quot;[onDeviceCallback] onDetected scene = &quot; + scene + &quot;,&quot; +</span><br><span class="line">                &quot;mLastScene:&quot; + mLastScene);</span><br><span class="line"></span><br><span class="line">        if (mLastScene != scene) &#123;</span><br><span class="line">            boolean suggestedHdr = (scene == SCENE_BACK_LIGHT</span><br><span class="line">                    || scene == SCENE_BACK_LIGHT_PORTRAIT);</span><br><span class="line">            // 通知camera ui场景的选择结果</span><br><span class="line">            mICameraAppUi.onDetectedSceneMode(scene, suggestedHdr);</span><br><span class="line">            mLastScene = scene;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="4-处理流程及消息回调-Hardware层"><a href="#4-处理流程及消息回调-Hardware层" class="headerlink" title="4. 处理流程及消息回调(Hardware层)"></a>4. 处理流程及消息回调(Hardware层)</h2><p>下面主要讲述在Hardware层，Asd是如何初始化其Client，然后根据camera设备提供的信息进行场景选择，将结果返回给framework层的Camera1，随后传递到上层Camera app的。首先来看看流程图。</p>
<h3 id="4-1-处理流程图"><a href="#4-1-处理流程图" class="headerlink" title="4.1 处理流程图"></a>4.1 处理流程图</h3><p><img src="/2018/01/12/Camera1架构和ASD流程源码分析/framework层流程图.png" alt="framework层流程图"></p>
<h3 id="4-2-Hardware层文件说明"><a href="#4-2-Hardware层文件说明" class="headerlink" title="4.2 Hardware层文件说明"></a>4.2 Hardware层文件说明</h3><ul>
<li><strong>FDClient、AsdClient.cpp :</strong>  Camera的每个feature好像都有一个专属的Client，每个Client又有专属的Client.Thead线程用来处理各类事件；而Asd的场景列表中有人脸模式（在后续的scene decider时也传入了facenum这样的参数）。这里没有进行深入研究，这里就先暂不拓展，因为整个camera架构还是很大的Orz</li>
<li><strong>asd_hal.cpp :</strong>  该流程的核心成员，主要功能是halASD实例的创建与销毁、ASD的初始化、场景选择。MTK在这里进行ASD各场景的阈值设置，同时分离了一个客制化的配置文件<code>camera_custom_asd.h</code>，客户可在HalAsdInit初始化的时候读取该客制化文件的值，从而客制化修改ASD场景的阈值；</li>
<li><strong>CameraClient.cpp :</strong>  用以接收来自AsdClient的回调消息；</li>
<li><strong>Camera.cpp :</strong>  上报回调消息到jni层；</li>
<li><strong>android_hardware_Camera.cpp :</strong>  jni层的实现</li>
</ul>
<h3 id="4-3-FD-Client-Thread-cpp"><a href="#4-3-FD-Client-Thread-cpp" class="headerlink" title="4.3 FD.Client.Thread.cpp"></a>4.3 FD.Client.Thread.cpp</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">// PreviewClient的state发生变化时会发送eID_WAKEUP消息</span><br><span class="line">// FDClient应该也会接收到，这里没去细看</span><br><span class="line">bool FDClient::threadLoop()</span><br><span class="line">&#123;</span><br><span class="line">    Command::EID cmd;</span><br><span class="line">    if  ( getCommand(cmd) )</span><br><span class="line">    &#123;</span><br><span class="line">        switch  (cmd)</span><br><span class="line">        &#123;</span><br><span class="line">        case Command::eID_WAKEUP:</span><br><span class="line">            // 初始化一些Client</span><br><span class="line">            onClientThreadLoop();</span><br><span class="line">            break;</span><br><span class="line">        //</span><br><span class="line">        case Command::eID_EXIT:</span><br><span class="line">        default:</span><br><span class="line">            MY_LOGD(&quot;Command::%d&quot;, cmd);</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void FDClient::onClientThreadLoop()</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    #if (1 == AUTO_SCENE_DETECT_SUPPORT)</span><br><span class="line">    //ASD Init</span><br><span class="line">    // 创建AsdClient实例</span><br><span class="line">    mpASDClient = IAsdClient::createInstance(mpParamsMgr);</span><br><span class="line">    // 调用AsdClient的init方法初始化AsdClient</span><br><span class="line">    if  ( mpASDClient == 0 || ! mpASDClient-&gt;init() )</span><br><span class="line">    &#123;</span><br><span class="line">        MY_LOGE(&quot;mpASDClient init failed&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    // 设置回调</span><br><span class="line">    mpASDClient-&gt;setCallbacks(mpCamMsgCbInfo);</span><br><span class="line">    #endif</span><br><span class="line">    //(3) Do in loop until stopFaceDetection has been called</span><br><span class="line">    //    either by sendCommand() or by stopPreview()</span><br><span class="line">    while ( isEnabledState() )</span><br><span class="line">    &#123;</span><br><span class="line">        ...</span><br><span class="line">        if (mpFDHalObj != NULL)</span><br><span class="line">        &#123;</span><br><span class="line">          // (3.4)</span><br><span class="line">          //performCallback(isDetected_FD, isDetected_SD);</span><br><span class="line">          performCallback(isDetected_FD, isDetected_SD, isDetected_GD);</span><br><span class="line"></span><br><span class="line">          #if (1 == AUTO_SCENE_DETECT_SUPPORT)</span><br><span class="line">          //Call ASD if doFD</span><br><span class="line">          if(isMsgEnabled())</span><br><span class="line">          &#123;</span><br><span class="line">              int FaceNum = mpFDHalObj-&gt;halFDGetFaceResult(mpDetectedFaces);</span><br><span class="line">              // 进行更新操作</span><br><span class="line">              // 这里开始进入到AsdClient的流程(场景选择/消息回调)</span><br><span class="line">              mpASDClient-&gt;update(DDPBuffer, srcWidth, srcHeight, FaceNum);</span><br><span class="line">          &#125;</span><br><span class="line">          #endif</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    #if (1 == AUTO_SCENE_DETECT_SUPPORT)</span><br><span class="line">    if (mpASDClient != 0)</span><br><span class="line">    &#123;</span><br><span class="line">        mpASDClient-&gt;uninit();</span><br><span class="line">        mpASDClient = NULL;</span><br><span class="line">    &#125;</span><br><span class="line">    #endif</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-4-AsdClient-cpp"><a href="#4-4-AsdClient-cpp" class="headerlink" title="4.4 AsdClient.cpp"></a>4.4 AsdClient.cpp</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">void</span><br><span class="line">AsdClient::</span><br><span class="line">update(MUINT8 * OT_Buffer, MINT32 a_Buffer_width, MINT32 a_Buffer_height, MINT32 a_FaceNum)</span><br><span class="line">&#123;</span><br><span class="line">    MUINT32 u4Scene = 0;</span><br><span class="line"></span><br><span class="line">    ASDInfo_T ASDInfo;</span><br><span class="line">    bool const isAsdEnabled = mpParamsMgr-&gt;getShotModeStr() == MtkCameraParameters::CAPTURE_MODE_ASD_SHOT;</span><br><span class="line">    enable(isAsdEnabled);</span><br><span class="line">    if  ( ! isEnabled() )</span><br><span class="line">    &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    //Get 3A Info.</span><br><span class="line">    MINT32 const i4SensorDevId = 1;</span><br><span class="line">    </span><br><span class="line">    //Need to be fixed. i4SensorDevId--&gt; i4SensorDevIdIndex, BinChang 2014/01/13</span><br><span class="line">    // 创建一个Hal3AAdapter实例，用以获取ASDInfo</span><br><span class="line">    mpHal3A = IHal3A::createInstance(NS3A::IHal3A::E_Camera_1, mpParamsMgr-&gt;getOpenId(), LOG_TAG);</span><br><span class="line">    mpHal3A-&gt;getASDInfo(ASDInfo);</span><br><span class="line">    if (mpHal3A)</span><br><span class="line">    &#123;</span><br><span class="line">        mpHal3A-&gt;destroyInstance(LOG_TAG);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    //Get FD Info.</span><br><span class="line">#if(0)</span><br><span class="line">    mpHalFD = halFDBase::createInstance(HAL_FD_OBJ_FDFT_SW);</span><br><span class="line">    mpHalFD-&gt;halFDGetFaceInfo(mpFaceInfo);</span><br><span class="line">    if(mpHalFD)</span><br><span class="line">    &#123;</span><br><span class="line">        mpHalFD-&gt;destroyInstance();</span><br><span class="line">    &#125;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    //Asd Pipe Init.</span><br><span class="line">    // 初始化Asd管道</span><br><span class="line">    if(mpHalASDObj == NULL)</span><br><span class="line">    &#123;</span><br><span class="line">        //Set Frame: Prepare QVGA RGB565 resolution</span><br><span class="line">        if(a_Buffer_width*3 == a_Buffer_height*4)</span><br><span class="line">            Buffer_height = 240;</span><br><span class="line">        else if(a_Buffer_width*9 == a_Buffer_height*16)</span><br><span class="line">            Buffer_height = 180;</span><br><span class="line">        else if(a_Buffer_width*3 == a_Buffer_height*5)</span><br><span class="line">            Buffer_height = 192;</span><br><span class="line">        else</span><br><span class="line">            Buffer_height = 240;</span><br><span class="line">    	// 创建halAsd实例</span><br><span class="line">        mpHalASDObj = halASDBase::createInstance(HAL_ASD_OBJ_AUTO);</span><br><span class="line">        if(mpHalASDObj == NULL)</span><br><span class="line">        &#123;</span><br><span class="line">            MY_LOGE(&quot;mpHalASDObj createInstance fail&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        // 初始化halAsd实例，这里传入了一个ASDInfo，里面是AWB的一些信息</span><br><span class="line">        // 参数的客制化修改也是在这里进行</span><br><span class="line">        mpHalASDObj-&gt;mHalAsdInit((void*)&amp;ASDInfo, mpWorkingBuf, (eSensorType==SENSOR_TYPE_RAW)?0:1, Buffer_width/2, Buffer_height/2);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    //Asd Pipe Decider</span><br><span class="line">    // 开始场景检测，这里交由mtk封装的camera算法lib库文件处理，结果是返回到mSceneCur</span><br><span class="line">    // 注意这里还传入了一个参数a_FaceNum，所以说FDClient跟AsdClient是有关联的</span><br><span class="line">    mpHalASDObj-&gt;mHalAsdDecider((void*)&amp;ASDInfo, a_FaceNum ,mSceneCur);</span><br><span class="line">    //MY_LOGD(&quot;ASDInfo.bAEBacklit:%d &quot;, ASDInfo.bAEBacklit);</span><br><span class="line">    //MY_LOGD(&quot;mSceneCur:%d &quot;, mSceneCur);</span><br><span class="line">    </span><br><span class="line">    u4Scene = mSceneCur;</span><br><span class="line">    </span><br><span class="line">    MY_LOGD(&quot;u4Scene:%d &quot;, u4Scene);</span><br><span class="line">    </span><br><span class="line">    if  (1)</span><br><span class="line">    &#123;</span><br><span class="line">    	// 消息处理，通知回调函数</span><br><span class="line">    	// 这里的mNotifyDb回调函数是在CameraClient的initialize函数里设置了</span><br><span class="line">    	// 对应CameraClient的notifyCallback函数，下面的CameraClient章节会说明一下这部分</span><br><span class="line">        mpCamMsgCbInfo-&gt;mNotifyCb(</span><br><span class="line">            MTK_CAMERA_MSG_EXT_NOTIFY, //msgType</span><br><span class="line">            MTK_CAMERA_MSG_EXT_NOTIFY_ASD, //ext1</span><br><span class="line">            u4Scene, //ext2</span><br><span class="line">            mpCamMsgCbInfo-&gt;mCbCookie</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    //MY_LOGD(&quot;Buffer_width:%d, Buffer_height:%d,&quot;, Buffer_width, Buffer_height);</span><br><span class="line">    // 场景选择后的处理，这里主要是做了一些缓存区的申请</span><br><span class="line">    mpHalASDObj-&gt;mHalAsdDoSceneDet((void*)OT_Buffer, Buffer_width, Buffer_height);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-5-asd-hal-cpp"><a href="#4-5-asd-hal-cpp" class="headerlink" title="4.5 asd_hal.cpp"></a>4.5 asd_hal.cpp</h3><p>Asd初始化：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">MINT32 halASD::mHalAsdInit(void* AAAData,void* working_buffer,MUINT8 SensorType, MINT32 Asd_Buf_Width, MINT32 Asd_Buf_Height)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    ASD_Customize_PARA1 ASDThres1; //客制化参数集1</span><br><span class="line">    ASD_Customize_PARA2 ASDThres2; //客制化参数集2</span><br><span class="line">    g_udCount++;</span><br><span class="line">    MY_LOGD(&quot;[halASD]  g_udCount++:%d \n&quot;, g_udCount);</span><br><span class="line">    AAA_ASD_PARAM* rASDInfo=(AAA_ASD_PARAM*)AAAData;</span><br><span class="line">    MINT32 Retcode = S_ASD_OK;</span><br><span class="line">    MUINT32* AFtable=(MUINT32*)malloc((rASDInfo-&gt;i4AFTableIdxNum + 1)*sizeof(MUINT32));</span><br><span class="line">    </span><br><span class="line">    // debug开关，可通过设置property来打开，从而查看更多log信息</span><br><span class="line">    char value[PROPERTY_VALUE_MAX] = &#123;&apos;\0&apos;&#125;;</span><br><span class="line">    property_get(&quot;ASD.debug.dump&quot;, value, &quot;0&quot;);</span><br><span class="line">    mHalASDDumpOPT = atoi(value);</span><br><span class="line">    </span><br><span class="line">    gMyAsdInitInfo.pInfo = &amp;gMyAsdEnvInfo;</span><br><span class="line">    gMyAsdInitInfo.pDeciderInfo = &amp;gMyDeciderEnvInfo;</span><br><span class="line">    gMyAsdInitInfo.pDeciderTuningInfo = &amp;gMyDeciderTuningInfo;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    //这里省略的代码是做gMyAsdInitInfo的一些初始化操作，其中比较关键的是pDeciderInfo的初始化</span><br><span class="line">    //主要是3A中的AWB、AF信息的获取和赋值</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    //这里将pDeciderInfo的指针地址赋值为0了，使用mtk camera算法底层库的默认册数</span><br><span class="line">    //如果需要对ASD的的参数进行客制化修改，需要注释掉这里</span><br><span class="line">    //不然在客制化赋值的时候会找不到正确的内存地址，而导致修改无效</span><br><span class="line">    gMyAsdInitInfo.pDeciderTuningInfo = 0;                        // use default value</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    /*  Create MTKPano Interface  */</span><br><span class="line">    //m_pMTKAsdObj用于调用底层库方法</span><br><span class="line">    if(m_pMTKAsdObj == NULL)</span><br><span class="line">    &#123;</span><br><span class="line">        m_pMTKAsdObj = MTKAsd::createInstance(DRV_ASD_OBJ_SW);</span><br><span class="line">        MY_LOGW_IF(m_pMTKAsdObj == NULL, &quot;Err&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">//客制化参数的获取和设置</span><br><span class="line">//if (0)默认不编译，如果需要进行客制化修改，这里需要改成if (1)</span><br><span class="line">#if (0)</span><br><span class="line">	//从camera_custom.h中获取客制化参数集</span><br><span class="line">    get_asd_CustomizeData1(&amp;ASDThres1);</span><br><span class="line">    get_asd_CustomizeData2(&amp;ASDThres2);</span><br><span class="line">    </span><br><span class="line">    //客制化参数设置</span><br><span class="line">    gMyAsdInitInfo.pDeciderTuningInfo-&gt;IdxWeightBlAe = ASDThres2.s2IdxWeightBlAe;</span><br><span class="line">    ...</span><br><span class="line">    gMyAsdInitInfo.pDeciderTuningInfo-&gt;EvLoThrNight = ASDThres2.s2EvLoThrNight;</span><br><span class="line">    gMyAsdInitInfo.pDeciderTuningInfo-&gt;EvHiThrNight = ASDThres2.s2EvHiThrNight;</span><br><span class="line">    ...</span><br><span class="line">    gMyAsdInitInfo.pDeciderTuningInfo-&gt;ScoreThrNight = ASDThres1.u1ScoreThrNight;</span><br><span class="line">    ...</span><br><span class="line">#endif</span><br><span class="line">	//初始化Asd</span><br><span class="line">    m_pMTKAsdObj-&gt;AsdInit(&amp;gMyAsdInitInfo, 0);</span><br><span class="line"></span><br><span class="line">    if (AFtable) &#123;</span><br><span class="line">        free(AFtable);</span><br><span class="line">    &#125;</span><br><span class="line">    return Retcode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Asd场景检测：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">MINT32 halASD::mHalAsdDecider(void* AAAData,MINT32 Face_Num,mhal_ASD_DECIDER_UI_SCENE_TYPE_ENUM &amp;Scene)</span><br><span class="line">&#123;</span><br><span class="line">      MINT32 Retcode = S_ASD_OK;</span><br><span class="line">      AAA_ASD_PARAM* rASDInfo=(AAA_ASD_PARAM*)AAAData;</span><br><span class="line">      ASD_DECIDER_RESULT_STRUCT MyDeciderResult;</span><br><span class="line">      ASD_SCD_RESULT_STRUCT gMyAsdResultInfo;</span><br><span class="line">      ASD_DECIDER_INFO_STRUCT gMyDeciderInfo;</span><br><span class="line">      </span><br><span class="line">      ...</span><br><span class="line">      //设置gMyDeciderInfo的Fd(人脸检测)、3A(AE&amp;AWB&amp;AF)信息</span><br><span class="line">      ...</span><br><span class="line">      </span><br><span class="line">      // 这里的m_pMTKAsdObj在Asd init的时候创建了，用以调用MTK底层库封装的函数</span><br><span class="line">      // AsdFeatureCtrl、AsdMain这两个函数的实现是在/vendor/xxx/libs中</span><br><span class="line">      // 可以通过 grep 关键字 来检索</span><br><span class="line">      m_pMTKAsdObj-&gt;AsdFeatureCtrl(ASD_FEATURE_GET_RESULT, 0, &amp;gMyAsdResultInfo);</span><br><span class="line">      memcpy(&amp;(gMyDeciderInfo.InfoScd),&amp;gMyAsdResultInfo, sizeof(ASD_SCD_RESULT_STRUCT));</span><br><span class="line">      m_pMTKAsdObj-&gt;AsdMain(ASD_PROC_DECIDER, &amp;gMyDeciderInfo);</span><br><span class="line">      m_pMTKAsdObj-&gt;AsdFeatureCtrl(DECIDER_FEATURE_GET_RESULT, 0, &amp;MyDeciderResult);</span><br><span class="line">      MY_LOGD(&quot;[mHalAsdDecider] detect Scene is %d, Face Num:%d \n&quot;,MyDeciderResult.DeciderUiScene, gMyDeciderInfo.InfoFd.FdFaceNum);</span><br><span class="line">    </span><br><span class="line">      // 得到场景检测的结果</span><br><span class="line">      Scene=(mhal_ASD_DECIDER_UI_SCENE_TYPE_ENUM) MyDeciderResult.DeciderUiScene;</span><br><span class="line">    </span><br><span class="line">      //Scene=mhal_ASD_DECIDER_UI_AUTO;</span><br><span class="line">      return Retcode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="4-6-CameraClient-cpp"><a href="#4-6-CameraClient-cpp" class="headerlink" title="4.6 CameraClient.cpp"></a>4.6 CameraClient.cpp</h3><p>首先先来说说AsdClient中提到的mNotifyCb函数，这个函数是在CameraClient的initialize函数中被定义的。我们来看看代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">status_t CameraClient::initialize(CameraModule *module) &#123;</span><br><span class="line">    ...</span><br><span class="line">    mHardware = new CameraHardwareInterface(camera_device_name);</span><br><span class="line">    ...</span><br><span class="line">    //调用的是Cam1DeviceBase的setCallback()函数</span><br><span class="line">    mHardware-&gt;setCallbacks(notifyCallback,</span><br><span class="line">            dataCallback,</span><br><span class="line">            dataCallbackTimestamp,</span><br><span class="line">            (void *)(uintptr_t)mCameraId);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接下来我们看看Cam1DeviceBase setCallback函数的实现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">// Set the notification and data callbacks</span><br><span class="line">void Cam1DeviceBase::setCallbacks(</span><br><span class="line">    camera_notify_callback notify_cb, //notify Callback函数</span><br><span class="line">    camera_data_callback data_cb, //data Callback函数</span><br><span class="line">    camera_data_timestamp_callback data_cb_timestamp,</span><br><span class="line">    camera_request_memory get_memory,</span><br><span class="line">    void*user</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    mpCamMsgCbInfo-&gt;mCbCookie       = user;</span><br><span class="line">    mpCamMsgCbInfo-&gt;mNotifyCb       = notify_cb; //mNotifyCb函数赋值</span><br><span class="line">    mpCamMsgCbInfo-&gt;mDataCb         = data_cb;   //mDataCb函数赋值</span><br><span class="line">    mpCamMsgCbInfo-&gt;mDataCbTimestamp= data_cb_timestamp;</span><br><span class="line">    mpCamMsgCbInfo-&gt;mRequestMemory  = get_memory;</span><br><span class="line">    //</span><br><span class="line">    if  ( mpCamClient != 0 )</span><br><span class="line">    &#123;</span><br><span class="line">        mpCamClient-&gt;setCallbacks(mpCamMsgCbInfo);</span><br><span class="line">    &#125;</span><br><span class="line">    // forward to registered clients</span><br><span class="line">    Vector&lt;sp&lt;ICamClient&gt; &gt;::const_iterator it;</span><br><span class="line">    for (it = vmpCamClient.begin(); it != vmpCamClient.end(); ++it)</span><br><span class="line">    &#123;</span><br><span class="line">        (*it)-&gt;setCallbacks(mpCamMsgCbInfo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //</span><br><span class="line">    if  ( mpCamAdapter != 0 )</span><br><span class="line">    &#123;</span><br><span class="line">        mpCamAdapter-&gt;setCallbacks(mpCamMsgCbInfo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>刚才我们分析到AsdClient在进行场景检测得到结果后，调用了mNotifyCb函数；根据上面的分析，mNotifyCb函数指向CameraClient的notifyCallback函数，来看看该函数的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">// Callback messages can be dispatched to internal handlers or pass to our</span><br><span class="line">// client&apos;s callback functions, depending on the message type.</span><br><span class="line">//</span><br><span class="line">// notifyCallback:</span><br><span class="line">//      CAMERA_MSG_SHUTTER              handleShutter</span><br><span class="line">//      (others)                        c-&gt;notifyCallback</span><br><span class="line">// dataCallback:</span><br><span class="line">//      CAMERA_MSG_PREVIEW_FRAME        handlePreviewData</span><br><span class="line">//      CAMERA_MSG_POSTVIEW_FRAME       handlePostview</span><br><span class="line">//      CAMERA_MSG_RAW_IMAGE            handleRawPicture</span><br><span class="line">//      CAMERA_MSG_COMPRESSED_IMAGE     handleCompressedPicture</span><br><span class="line">//      (others)                        c-&gt;dataCallback</span><br><span class="line">// dataCallbackTimestamp</span><br><span class="line">//      (others)                        c-&gt;dataCallbackTimestamp</span><br><span class="line">void CameraClient::notifyCallback(int32_t msgType, int32_t ext1,</span><br><span class="line">        int32_t ext2, void* user) &#123;</span><br><span class="line">    LOG2(&quot;notifyCallback(%d)&quot;, msgType);</span><br><span class="line"></span><br><span class="line">    sp&lt;CameraClient&gt; client = static_cast&lt;CameraClient*&gt;(getClientFromCookie(user).get());</span><br><span class="line">    if (client.get() == nullptr) return;</span><br><span class="line"></span><br><span class="line">    if (!client-&gt;lockIfMessageWanted(msgType)) return;</span><br><span class="line"></span><br><span class="line">    switch (msgType) &#123;</span><br><span class="line">        //!++</span><br><span class="line">        case MTK_CAMERA_MSG_EXT_NOTIFY:</span><br><span class="line">            client-&gt;handleMtkExtNotify(ext1, ext2); // Callback extended msg notification.</span><br><span class="line">            break;</span><br><span class="line">        //!--</span><br><span class="line">        case CAMERA_MSG_SHUTTER:</span><br><span class="line">            // ext1 is the dimension of the yuv picture.</span><br><span class="line">            client-&gt;handleShutter();</span><br><span class="line">            break;</span><br><span class="line">        default:</span><br><span class="line">            client-&gt;handleGenericNotify(msgType, ext1, ext2);</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>mNotifyCb函数调用传入的msgType是<code>MTK_CAMERA_MSG_EXT_NOTIFY</code> ，那么接下来会执行到<code>handleMtkExtNotify</code>，该函数在Mediatek自己写的CameraClient.cpp中实现。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">void CameraClient::handleMtkExtNotify(int32_t ext1, int32_t ext2)</span><br><span class="line">&#123;</span><br><span class="line">    int32_t const extMsgType = ext1;</span><br><span class="line">    switch  (extMsgType)</span><br><span class="line">    &#123;</span><br><span class="line">    case MTK_CAMERA_MSG_EXT_NOTIFY_CAPTURE_DONE:</span><br><span class="line">        handleMtkExtCaptureDone(ext1, ext2);</span><br><span class="line">        break;</span><br><span class="line">    //</span><br><span class="line">    case MTK_CAMERA_MSG_EXT_NOTIFY_SHUTTER:</span><br><span class="line">        handleMtkExtShutter(ext1, ext2);</span><br><span class="line">        break;</span><br><span class="line">    //</span><br><span class="line">    case MTK_CAMERA_MSG_EXT_NOTIFY_BURST_SHUTTER:</span><br><span class="line">        handleMtkExtBurstShutter(ext1, ext2);</span><br><span class="line">        break;</span><br><span class="line">    case MTK_CAMERA_MSG_EXT_NOTIFY_CONTINUOUS_SHUTTER:</span><br><span class="line">        handleMtkExtContinuousShutter(ext1, ext2);</span><br><span class="line">        break;</span><br><span class="line">    case MTK_CAMERA_MSG_EXT_NOTIFY_CONTINUOUS_END:</span><br><span class="line">        handleMtkExtContinuousEnd(ext1, ext2);</span><br><span class="line">        break;</span><br><span class="line">    //</span><br><span class="line">    default:</span><br><span class="line">        handleGenericNotify(MTK_CAMERA_MSG_EXT_NOTIFY, ext1, ext2);</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>传入的ext1为<code>MTK_CAMERA_MSG_EXT_NOTIFY_ASD</code>，所以又走回Android原生 CameraClient 的handleGenericNotify函数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">void CameraClient::handleGenericNotify(int32_t msgType,</span><br><span class="line">    int32_t ext1, int32_t ext2) &#123;</span><br><span class="line">    //!++</span><br><span class="line">    #ifdef MTK_CAM_FRAMEWORK_DEFAULT_CODE</span><br><span class="line">    //!--</span><br><span class="line">    sp&lt;hardware::ICameraClient&gt; c = mRemoteCallback;</span><br><span class="line">    //!++</span><br><span class="line">    #else</span><br><span class="line">    sp&lt;hardware::ICameraClient&gt; c;</span><br><span class="line">    &#123;</span><br><span class="line">        Mutex::Autolock remoteCallbacklock(mRemoteCallbackLock);</span><br><span class="line">        c = mRemoteCallback;</span><br><span class="line">    &#125;</span><br><span class="line">    #endif</span><br><span class="line">    //!--</span><br><span class="line">    //!++ There some dead lock issue in camera hal, so we need to disable this function before all dead lock issues hase been fixed.</span><br><span class="line">    #ifdef MTK_CAM_FRAMEWORK_DEFAULT_CODE</span><br><span class="line">    mLock.unlock();</span><br><span class="line">    #endif</span><br><span class="line">    //!--</span><br><span class="line">    // 除了notifyCallback这种方式，在看Preview流程时还有一种方式是</span><br><span class="line">    // copy当前帧然后把copy后的数据直接发送出去</span><br><span class="line">    if (c != 0) &#123;</span><br><span class="line">        c-&gt;notifyCallback(msgType, ext1, ext2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>由上可知消息是通过<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;hardware::ICameraClient&gt; c = mRemoteCallback; </span><br><span class="line">c-&gt;notifyCallback(msgType, ext1, ext2);</span><br></pre></td></tr></table></figure></p>
<p>的方式发送出去的。</p>
<p>那这个mRemoteCallback又是在哪里初始化的呢？检索了一下，是在CameraClient::connect中被赋值了，继续跟踪下去，会发现是在CameraClient的构造函数里初始化的，这里涉及到了多层继承(CameraClient-&gt;CameraService-&gt;Client)，看看代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">step1：</span><br><span class="line">CameraClient::CameraClient(const sp&lt;CameraService&gt;&amp; cameraService,</span><br><span class="line">        const sp&lt;hardware::ICameraClient&gt;&amp; cameraClient, // 这里传入了一个ICameraClient</span><br><span class="line">        const String16&amp; clientPackageName,</span><br><span class="line">        int cameraId, int cameraFacing,</span><br><span class="line">        int clientPid, int clientUid,</span><br><span class="line">        int servicePid, bool legacyMode):</span><br><span class="line">        // 这里开始调用Client的构造函数，传入一个cameraClient参数</span><br><span class="line">        // Client是CameraService底下的一个内部类</span><br><span class="line">        Client(cameraService, cameraClient, clientPackageName,</span><br><span class="line">                cameraId, cameraFacing, clientPid, clientUid, servicePid)</span><br><span class="line">                </span><br><span class="line">step2：</span><br><span class="line">CameraService::Client::Client(const sp&lt;CameraService&gt;&amp; cameraService,</span><br><span class="line">        const sp&lt;ICameraClient&gt;&amp; cameraClient,</span><br><span class="line">        const String16&amp; clientPackageName,</span><br><span class="line">        int cameraId, int cameraFacing,</span><br><span class="line">        int clientPid, uid_t clientUid,</span><br><span class="line">        int servicePid) :</span><br><span class="line">        CameraService::BasicClient(cameraService,</span><br><span class="line">                IInterface::asBinder(cameraClient),</span><br><span class="line">                clientPackageName,</span><br><span class="line">                cameraId, cameraFacing,</span><br><span class="line">                clientPid, clientUid,</span><br><span class="line">                servicePid)</span><br><span class="line">&#123;</span><br><span class="line">    int callingPid = getCallingPid();</span><br><span class="line">    LOG1(&quot;Client::Client E (pid %d, id %d)&quot;, callingPid, cameraId);</span><br><span class="line">	</span><br><span class="line">	// 这里对mRemoteCallback进行了赋值初始化</span><br><span class="line">    mRemoteCallback = cameraClient;</span><br><span class="line"></span><br><span class="line">    cameraService-&gt;loadSound();</span><br><span class="line">    LOG1(&quot;Client::Client X (pid %d, id %d)&quot;, callingPid, cameraId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>那么思路就清晰了，我们只需要看一下这个CameraClient进行了初始化就可以了。从Camera的connect方法看一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">step 1：</span><br><span class="line">sp&lt;Camera&gt; Camera::connect(int cameraId, const String16&amp; clientPackageName,</span><br><span class="line">        int clientUid, int clientPid)</span><br><span class="line">&#123;</span><br><span class="line">	// CameraBaseT在CameraBase中被定义：typedef CameraBase&lt;TCam&gt; CameraBaseT</span><br><span class="line">	// CameraBase在Camera被初始化为CameraBase&lt;Camera&gt;，所以上面就相应于调用了		</span><br><span class="line">	// CameraBase&lt;Camera&gt;::connect()</span><br><span class="line">    return CameraBaseT::connect(cameraId, clientPackageName, clientUid, clientPid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">step 2：</span><br><span class="line">template &lt;typename TCam, typename TCamTraits&gt;</span><br><span class="line">sp&lt;TCam&gt; CameraBase&lt;TCam, TCamTraits&gt;::connect(int cameraId,</span><br><span class="line">                                               const String16&amp; clientPackageName,</span><br><span class="line">                                               int clientUid, int clientPid)</span><br><span class="line">&#123;</span><br><span class="line">    ALOGV(&quot;%s: connect&quot;, __FUNCTION__);</span><br><span class="line">    // 构造Camera实例</span><br><span class="line">    sp&lt;TCam&gt; c = new TCam(cameraId);</span><br><span class="line">    // TCamCallbacks在Camera.h中被定义为ICameraClient</span><br><span class="line">    // 这里cl = c被赋值为Camera类型，而Camera继承了ICameraClient</span><br><span class="line">    sp&lt;TCamCallbacks&gt; cl = c;</span><br><span class="line">    const sp&lt;::android::hardware::ICameraService&gt; cs = getCameraService();</span><br><span class="line"></span><br><span class="line">    binder::Status ret;</span><br><span class="line">    if (cs != nullptr) &#123;</span><br><span class="line">    	// fnConnectService在Camera被初始化为ICameraService::connect()</span><br><span class="line">        TCamConnectService fnConnectService = TCamTraits::fnConnectService;</span><br><span class="line">        // 这里调用了CameraService::connect() c和cl是同一个值，做为两个不同的参数传进了</span><br><span class="line">        // CameraService::connect()</span><br><span class="line">        ret = (cs.get()-&gt;*fnConnectService)(cl, cameraId, clientPackageName, clientUid,</span><br><span class="line">                                               clientPid, /*out*/ &amp;c-&gt;mCamera);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    return c;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">step 3：</span><br><span class="line">// CameraService::connec()构造了一个CameraClient(),又是一个CameraClient，</span><br><span class="line">// 但是和上面的ICameraClient没有半毛线关系。只是名字相似,真的是一万个++泥马在奔腾。</span><br><span class="line">status_t CameraService::connect(const sp&lt;ICameraClient&gt;&amp; cameraClient, int cameraId,</span><br><span class="line">        const String16&amp; clientPackageName, int clientUid, /*out*/sp&lt;ICamera&gt;&amp; device) &#123;</span><br><span class="line"> </span><br><span class="line">	// CameraService::connect()就做了两件事情</span><br><span class="line">	// 初始化Camera里的mCamera和把Camera(参数cameraClient为Camera类型)传给CameraClient</span><br><span class="line">	// 由上面的分析我们知道CameraClient的构造函数最后会走到CameraService中的Client构造函数</span><br><span class="line">	// 所以说，Camera类就是mRemoteCallback</span><br><span class="line">    client = new CameraClient(this, cameraClient, clientPackageName, cameraId,</span><br><span class="line">                    facing, callingPid, clientUid, getpid());</span><br><span class="line">        </span><br><span class="line">    device = client;</span><br><span class="line">    return OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以，使用的c-&gt;notifyCallback调用的是<code>Camera::notifyCallback</code>。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// callback from camera service</span><br><span class="line">void Camera::notifyCallback(int32_t msgType, int32_t ext1, int32_t ext2)</span><br><span class="line">&#123;</span><br><span class="line">    return CameraBaseT::notifyCallback(msgType, ext1, ext2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">template &lt;typename TCam, typename TCamTraits&gt;</span><br><span class="line">void CameraBase&lt;TCam, TCamTraits&gt;::notifyCallback(int32_t msgType, int32_t ext1, int32_t ext2)</span><br><span class="line">&#123;</span><br><span class="line">    sp&lt;TCamListener&gt; listener;</span><br><span class="line">    &#123;</span><br><span class="line">        Mutex::Autolock _l(mLock);</span><br><span class="line">        listener = mListener;</span><br><span class="line">    &#125;</span><br><span class="line">    if (listener != NULL) &#123;</span><br><span class="line">        listener-&gt;notify(msgType, ext1, ext2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里的mListener是在android_hardware_Camera.cpp被设置，接下来我们进入到JNI层(终于快到Java层了^^)。</p>
<h2 id="5-消息上报-jni层"><a href="#5-消息上报-jni层" class="headerlink" title="5. 消息上报(jni层)"></a>5. 消息上报(jni层)</h2><p>首先我们先看一下mListener的设置代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">static jint android_hardware_Camera_native_setup(...)</span><br><span class="line">&#123;</span><br><span class="line">    sp&lt;Camera&gt; camera;</span><br><span class="line">    sp&lt;JNICameraContext&gt; context = new MtkJNICameraContext(env, weak_this, clazz, camera);</span><br><span class="line">    // 设置mListener，类型为MtkJNICameraContext</span><br><span class="line">    camera-&gt;setListener(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以listener-&gt;notify调用的是<code>MtkJNICameraContext::notify</code>函数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">void JNICameraContext::notify(int32_t msgType, int32_t ext1, int32_t ext2)</span><br><span class="line">&#123;</span><br><span class="line">    ALOGV(&quot;notify&quot;);</span><br><span class="line">    ...</span><br><span class="line">    // 这里的post_event在android_hardware_Camera.cpp中有被定义postEventFromNative()</span><br><span class="line">    // 所以会调用到frameworks/base/core/java/android/hardware/Camera.java的</span><br><span class="line">    // postEventFromNative方法</span><br><span class="line">    env-&gt;CallStaticVoidMethod(mCameraJClass, fields.post_event,</span><br><span class="line">            mCameraJObjectWeak, msgType, ext1, ext2, NULL);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">jclass clazz = FindClassOrDie(env, &quot;android/hardware/Camera&quot;);</span><br><span class="line">fields.post_event = GetStaticMethodIDOrDie(env, clazz, &quot;postEventFromNative&quot;,</span><br><span class="line">                                               &quot;(Ljava/lang/Object;IIILjava/lang/Object;)V&quot;);</span><br></pre></td></tr></table></figure></p>
<p>那么我们来看一下Camera.java中做了什么操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">private static void postEventFromNative(Object camera_ref,</span><br><span class="line">                                        int what, int arg1, int arg2, Object obj)</span><br><span class="line">&#123;</span><br><span class="line">    Camera c = (Camera)((WeakReference)camera_ref).get();</span><br><span class="line">    if (c == null)</span><br><span class="line">        return;</span><br><span class="line"></span><br><span class="line">    if (c.mEventHandler != null) &#123;</span><br><span class="line">        Message m = c.mEventHandler.obtainMessage(what, arg1, arg2, obj);</span><br><span class="line">        // 这里把hardware层上来的消息发送出去了，在Camera的内部类EventHandler中处理</span><br><span class="line">        c.mEventHandler.sendMessage(m);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private class EventHandler extends Handler </span><br><span class="line">&#123;</span><br><span class="line">  	@Override</span><br><span class="line">    public void handleMessage(Message msg) &#123;</span><br><span class="line">    	case MTK_CAMERA_MSG_EXT_NOTIFY:</span><br><span class="line">    		case MTK_CAMERA_MSG_EXT_NOTIFY_ASD:</span><br><span class="line">                    if (mAsdCallback != null) &#123;</span><br><span class="line">                    	// 这里回调到Asd中声明的AsdCallback里</span><br><span class="line">                        mAsdCallback.onDetected(msg.arg2);</span><br><span class="line">                    &#125;</span><br><span class="line">                    break;</span><br><span class="line">        ....</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ok，到这里消息在JNI层是如何被处理、上报到framework再到App就结束了。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a class="article-share-link" data-url="http://yoursite.com/2018/01/12/Camera1架构和ASD流程源码分析/" data-id="cjcb9rh6i00019suqkfz0sqmq" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAN4AAADeCAAAAAB3DOFrAAACsElEQVR42u3aQW7jQAwEQP//015gb3uw3E1qHGdROgWOIE3pMCR6+HjE1/PvldyT3/nql+fl9Thx4eHh4Y2Wfv246xfki5t9putf3jwfDw8P7xivXXSyxbf7dv6uZM14eHh438BL8EmTnRcePDw8vP+VlyQA17/PigceHh7ez/KSMGIWDVwXhjbmOJi14OHh4R04Rfqevw+e7+Hh4eEtTtXb6HYTT2zKwMvV4uHh4R3gtYdbeVSxCWfvCizw8PDwTvA2I1D3FonZp3zzNx4eHt4BXnsAlj+6OKCKP8rw7Xh4eHgHeNevz1+ZbPf7JnszkoWHh4d3jpeMWG1a4dkp1ez5eHh4eCd4m2GmNvZdjUbNog08PDy8W3mz4YB7g9fNEdebAoaHh4d3gNeGEfkS87GtTdtdI/Hw8PDWvHzQKm+XN58gb/GLMoCHh4d3Ky9PO9seNT8Gm40d1Gw8PDy8m3gt48TWP2vNrz8NHh4e3jnebDhglnMkQUMb+xahBh4eHt5NvLuW3m7x+dafDyK8rHt4eHh4B3hJe5o0r3m4MIxig7cUkxF4eHh4C16yfef354Wh/XCrQy88PDy8W3ltJDobjWoHvNpPj4eHh/cZ3qzNzV8w2/o3aysmI/Dw8PAWvPZoahNebIYSkpITRRJ4eHh4C17e/uaN+Cy2aMezolKEh4eH90FeG0bsw9w2boiKEB4eHt4BXrvh5g30Jl/dDxPUCQoeHh5ezHuWVxsuJIMCM3z0HDw8PLwDvP3Je8toP00bduDh4eF9hjcrBjmyPeJqC0OdOuPh4eHdxNsUg32ku2EMUxY8PDy8j/DyRjbZ7vN2uS1peHh4eL+Rl5SWNinJI91/noaHh4d3jDc79Eoa3/a/efMdPQEPDw/vAG+ThbbHV5vA9+AAAR4eHl565x9LEH2CuiQdnQAAAABJRU5ErkJggg==">分享</a><div class="tags"><a href="/tags/Android系统/">Android系统</a><a href="/tags/Camera/">Camera</a></div><div class="post-nav"><a class="next" href="/2018/01/11/Hello Hexo/">Hello Hexo</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank"><input type="search" name="word" maxlength="20" placeholder="Search"/><input type="hidden" name="si" value="http://yoursite.com"/><input name="tn" type="hidden" value="bds"/><input name="cl" type="hidden" value="3"/><input name="ct" type="hidden" value="2097152"/><input name="s" type="hidden" value="on"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Diary/">Diary</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Android系统/" style="font-size: 15px;">Android系统</a> <a href="/tags/Camera/" style="font-size: 15px;">Camera</a> <a href="/tags/随笔/" style="font-size: 15px;">随笔</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/01/12/Camera1架构和ASD流程源码分析/">Camera1架构和ASD流程源码分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/11/Hello Hexo/">Hello Hexo</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://liiiyx.lofter.com/" title="liiiyx's lofter" target="_blank">liiiyx's lofter</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">liiiyx's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>